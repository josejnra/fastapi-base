# Collector configuration reference
# https://opentelemetry.io/docs/collector/configuration/

extensions:
  zpages:
    endpoint: 0.0.0.0:55679

# receivers reference
# https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

# exporters reference
# https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter
exporters:
  # tracing
  otlp/tempo:
    endpoint: tempo:4317       # Endpoint for Tempo to send traces
    tls:
      insecure: true

  # zipkin:
  #   endpoint: http://zipkin:9411/api/v2/spans
  #   tls:
  #     insecure: true  

  # metrics
  prometheus:  # expose metrics in prometheus format at otel collector
    endpoint: otel_collector:8889
    metric_expiration: 180m
    const_labels:
      env: fastapi-prod

  #logs
  otlphttp/logs:
    endpoint: http://loki:3100/otlp
    tls:
      insecure: true

processors:
  batch:

# https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/troubleshooting.md
service:
  # https://opentelemetry.io/docs/collector/configuration/#telemetry
  telemetry:
    logs:
      level: "debug"
    metrics:
      address: ":8888"  # otel collector metrics prometheus format exposed at /metrics
      level: detailed

  extensions:
    - zpages

  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp/tempo]
    logs:
      receivers: [otlp]
      exporters: [otlphttp/logs]
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [prometheus]
